name: Release Conda Package
on:
  workflow_run:
    workflows: ["Test code"]
    branches: [main]
    types: 
      - completed
  push:
    tags:
    - '*'

jobs:
  deploy:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.6", "3.7"]

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: '3.x'

    - name: Dump exact dependencies yaml file
      run: |
        conda create -n writedeps -y python=${{ matrix.python-version }}
        conda init bash
        conda activate writedeps
        conda install --file package/htmd-deps/DEPENDENCIES -y -c acellera -c conda-forge 
        python package/htmd-deps/write_meta_yaml.py package/htmd-deps
        conda deactivate

    - name: Build htmd-deps conda package
      run: |
        export TAG_DESCRIBE=$(git describe)
        export BUILD_VERSION=$(echo $TAG_DESCRIBE | sed 's/-/ /g'  | awk '{print $1}')
        conda install anaconda-client conda-build python=${{ matrix.python-version }}
        conda build --python ${{ matrix.python-version }} package/htmd-deps --output-folder ./pkg/ --no-include-recipe --no-anaconda-upload -c acellera -c conda-forge

    - name: Build htmd conda package
      run: |
        export TAG_DESCRIBE=$(git describe)
        export BUILD_VERSION=$(echo $TAG_DESCRIBE | sed 's/-/ /g'  | awk '{print $1}')
        conda build --python ${{ matrix.python-version }} package/htmd --output-folder ./pkg/ --no-include-recipe --no-anaconda-upload -c acellera -c conda-forge
    
    - name: Upload to conda
      run: |
        anaconda -t ${{ secrets.ANACONDA_TOKEN_BASIC }} upload -u acellera ./pkg/*/htmd-*.tar.bz2
