steps:
- bash: |
    conda install --file package/htmd-deps/DEPENDENCIES -y -c acellera -c psi4 -c conda-forge  # Installing dependencies for getting latest package versions
  displayName: Install Anaconda packages

- bash: |
    export TAG_DESCRIBE=$(git describe)
    export BUILD_VERSION=$(echo $TAG_DESCRIBE | sed 's/-/ /g'  | awk '{print $1}')
    python package/htmd-deps/write_meta_yaml.py package/htmd-deps
    conda build --python $(python.version) package/htmd-deps --no-include-recipe --output-folder ./conda_build/ --no-anaconda-upload -c acellera -c psi4 -c conda-forge
  displayName: Building htmd-deps conda package

- bash: |
    export TAG_DESCRIBE=$(git describe)
    export BUILD_VERSION=$(echo $TAG_DESCRIBE | sed 's/-/ /g'  | awk '{print $1}')
    conda build --python $(python.version) package/htmd --no-include-recipe --output-folder ./conda_build/ --no-anaconda-upload -c acellera -c psi4 -c conda-forge
  displayName: Building htmd conda package

- task: CopyFiles@2
  displayName: 'Copy conda builds to: $(Build.ArtifactStagingDirectory)'
  inputs:
    Contents: conda_build/*/htmd-*.tar.bz2
    targetFolder: $(Build.ArtifactStagingDirectory)/conda/
    flattenFolders: true